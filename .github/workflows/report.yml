name: LeetCode Report (Bun, multi-user, gated)

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ KST 10:00 ì‹¤í–‰ (UTC 01:00)
    - cron: "0 1 * * 1"
  workflow_dispatch: {}

permissions:
  contents: write # reports/* ì»¤ë°‹ì„ ìœ„í•´ í•„ìš”

jobs:
  report:
    runs-on: self-hosted # ê°™ì€ ë¨¸ì‹ ì—ì„œ http://localhost:3000 ì ‘ê·¼ ê°€ëŠ¥
    env:
      # ê³µê°œ ê¸°ë³¸ê°’(Secrets ì—†ì„ ë•Œ fallback)
      TARGET_FOR_PERIOD: "7"
      PERIOD_DAYS: "7"
      TZ: Asia/Seoul
      DEDUPE_MODE: WINDOW_UNIQUE # DAILY_UNIQUE | WINDOW_UNIQUE | ALL_SUBMISSIONS
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.29"

      # --- â‘  ê²Œì´íŠ¸: ì„¤ì •ëœ ì£¼ê¸°(ì£¼ ë‹¨ìœ„) ì§€ë‚¬ëŠ”ì§€ í™•ì¸ ---
      - name: Report gate (period check)
        id: gate
        run: bun scripts/report_gate.mjs

      # --- â‘¡ ë¦¬í¬íŠ¸ ì‹¤í–‰ (ê²Œì´íŠ¸ í†µê³¼ì‹œì—ë§Œ) ---
      - name: Run report
        if: steps.gate.outputs.should_run == 'true'
        env:
          # ğŸ” Repository Secrets ê¶Œì¥
          API_BASE: ${{ secrets.API_BASE }} # ì˜ˆ: http://localhost:3000
          USERS: ${{ secrets.USERS }} # ì˜ˆ: moo,ryu (ì½¤ë§ˆ)
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TARGET_FOR_PERIOD: ${{ env.TARGET_FOR_PERIOD }}
          PERIOD_DAYS: ${{ env.PERIOD_DAYS }}
          TZ: ${{ env.TZ }}
          DEDUPE_MODE: ${{ env.DEDUPE_MODE }}
        run: bun scripts/run-report.ts

      # --- â‘¢ ì»¤ë°‹ (ê²Œì´íŠ¸ í†µê³¼ì‹œì—ë§Œ) ---
      - name: Commit & push report
        if: steps.gate.outputs.should_run == 'true'
        run: |
          git config user.name "gh-bot"
          git config user.email "actions@users.noreply.github.com"
          git add reports/
          git commit -m "chore(report): period" || echo "No changes"
          git push
