name: Biweekly LeetCode Report (Bun, multi-user)

on:
  schedule:
    # ⏰ 매 2주마다 KST(UTC+9) 자정에 가깝게 실행하려면:
    # 자정 KST ~= 15:00 UTC 전날 → 2주 간격: */14 사용
    - cron: "0 15 */14 * *"
  workflow_dispatch: {}

permissions:
  contents: write # reports/* 커밋을 위해 필요

jobs:
  report:
    runs-on: self-hosted # 도커 API가 같은 머신에서 localhost:3000 으로 열려 있어야 함
    env:
      # ✅ 공통 기본값(Secrets 미설정 시 fallback)
      TARGET_2WEEKS: "20"
      TZ: Asia/Seoul
      DEDUPE_MODE: WINDOW_UNIQUE # DAILY_UNIQUE | WINDOW_UNIQUE | ALL_SUBMISSIONS
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.29"

      # (의존성 없으면 install 스텝 생략 가능)
      # - name: Install deps
      #   run: bun install

      - name: Run biweekly report
        env:
          # 🔐 필수 Secrets
          API_BASE: ${{ secrets.API_BASE }} # 예: http://localhost:3000
          USERS: ${{ secrets.USERS }} # 예: moo,ryu  (콤마 구분)
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TARGET_2WEEKS: ${{ env.TARGET_2WEEKS }}
          TZ: ${{ env.TZ }}
          DEDUPE_MODE: ${{ env.DEDUPE_MODE }}
        run: bun scripts/run-biweekly.ts

      - name: Commit & push report
        run: |
          git config user.name "gh-bot"
          git config user.email "actions@users.noreply.github.com"
          git add reports/
          git commit -m "chore(report): biweekly" || echo "No changes"
          git push
